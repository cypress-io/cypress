<template>
  <div
    data-cy="debug-spec-col"
    class="flex flex-col grid px-24px gap-24px self-stretch mb-24px"
  >
    <DebugSpec
      v-for="spec in specs"
      :key="spec.spec.id"
      :spec="spec.spec"
      :test-results="spec.tests"
    />
  </div>
</template>

<script setup lang="ts">
import { gql } from '@urql/core'
import { computed } from '@vue/reactivity'
import type { DebugSpecListSpecFragment, DebugSpecListTestsFragment } from '../generated/graphql'
import DebugSpec from './DebugSpec.vue'

gql`
fragment DebugSpecListSpec on CloudSpecRun {
  id
  path
  basename
  extension
  shortPath
  groupIds
  testsPassed {
    min
    max
  }
  testsFailed {
    min
    max
  }
  testsPending {
    min
    max
  }
}
`

gql`
fragment DebugSpecListTests on TestResult {
  id
  specId
  title(depth: 2)
  titleParts
  duration
  isFlaky
  testUrl
  instance {
    id
    status
    groupId
    totalPassed
    totalFailed
    totalPending
    totalSkipped
    totalRunning
    hasStdout
    stdoutUrl
    hasScreenshots
    screenshotsUrl
    hasVideo
    videoUrl
  }
}
`

const props = defineProps<{
  specs: { spec: DebugSpecListSpecFragment, tests: DebugSpecListTestsFragment[] }[]
}>()

const specs = computed(() => {
  return props.specs.map((specItem) => {
    return {
      spec: {
        id: specItem.spec.id,
        path: specItem.spec.path.replace(specItem.spec.basename, ''),
        fileName: specItem.spec.basename,
        fileExtension: specItem.spec.basename.substring(specItem.spec.basename.indexOf('.')),
      },
      tests: specItem.tests,
    }
  })
})

</script>
